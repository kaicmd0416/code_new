# 实时跟踪系统

## 项目概述

本项目是一个实时金融投资组合和产品跟踪系统，主要用于监控和分析期货、期权、股票、ETF和可转债等金融产品的持仓变化、收益计算和风险分析。系统支持多产品并行处理，具备自动化数据清理、历史数据保存和实时计算功能。

## 项目结构

```
Tracking_realtime/
├── running_main.py                    # 主程序入口，系统调度中心
├── history_sql_saving.py             # 历史数据保存模块
├── data/
│   └── data_prepared.py              # 数据准备和分类模块
├── calculate_main/
│   ├── product_calculate.py          # 单个产品计算模块
│   └── portfolio_calculate.py        # 投资组合计算模块
├── global_setting/
│   ├── global_dic.py                 # 全局配置管理
│   └── tracking_path_config.json     # 路径配置文件
└── project_config/
    ├── trackingrealtime_sql.yaml     # SQL配置
    └── product_detail.yaml           # 产品详细信息配置
```

## 核心功能模块

### 1. 数据准备模块 (data/data_prepared.py)
- **功能**：处理原始数据，标准化列名，分类资产类型
- **主要类**：
  - `futureoption_position`: 期货期权持仓数据处理
  - `security_position`: 股票/ETF/可转债持仓数据处理
  - `prod_info`: 产品信息处理
  - `weight_withdraw`: 权重提取

### 2. 计算模块 (calculate_main/)
- `product_calculate.py`: 单个产品收益和市值计算
- `portfolio_calculate.py`: 投资组合级别计算

### 3. 历史数据管理 (history_sql_saving.py)
- **功能**：将实时数据迁移到历史表进行持久化存储

### 4. 配置管理 (global_setting/global_dic.py)
- **功能**：管理全局路径和配置，支持本地/SQL数据源切换

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        实时跟踪系统架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  数据输入    │    │  配置管理    │    │  时间调度    │         │
│  │             │    │             │    │             │         │
│  │ • CSV文件    │    │ • YAML配置  │    │ • 工作日判断 │         │
│  │ • SQL查询    │    │ • JSON路径  │    │ • 时间条件   │         │
│  │ • 实时数据   │    │ • 环境变量  │    │ • 自动化触发 │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                   │                   │               │
│         └───────────────────┼───────────────────┘               │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    数据准备层                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │期货期权处理  │  │股票ETF处理   │  │产品信息处理  │         │ │
│  │  │             │  │             │  │             │         │ │
│  │  │• 资产分类    │  │• 资产分类    │  │• 产品详情    │         │ │
│  │  │• 数据标准化  │  │• 数据标准化  │  │• 配置读取    │         │ │
│  │  │• 空值处理    │  │• 空值处理    │  │• 数值处理    │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    计算分析层                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │产品级计算    │  │组合级计算    │  │收益分析      │         │ │
│  │  │             │  │             │  │             │         │ │
│  │  │• 收益计算    │  │• 组合汇总    │  │• 收益率      │         │ │
│  │  │• 市值计算    │  │• 权重分析    │  │• 风险指标    │         │ │
│  │  │• 持仓分析    │  │• 基准对比    │  │• 绩效评估    │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    数据存储层                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │实时数据表    │  │历史数据表    │  │配置数据      │         │ │
│  │  │             │  │             │  │             │         │ │
│  │  │• 持仓变化    │  │• 历史持仓    │  │• 产品详情    │         │ │
│  │  │• 实时收益    │  │• 历史收益    │  │• 路径配置    │         │ │
│  │  │• 产品信息    │  │• 绩效数据    │  │• SQL配置    │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 主要数据流程

### 1. 系统启动流程
```
┌─────────────┐
│  running_main.py │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 检查工作日   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 检查时间条件 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 数据表管理   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 投资组合跟踪 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 产品级跟踪   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 历史数据保存 │
└─────────────┘
```

### 2. 数据处理流程
```
┌─────────────┐
│ 原始数据输入 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 数据标准化   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 资产分类     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 空值处理     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 数据验证     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 输出处理结果 │
└─────────────┘
```

### 3. 计算分析流程
```
┌─────────────┐
│ 产品数据输入 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 期货期权分析 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 股票ETF分析  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 可转债分析   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 收益计算     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 市值计算     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 结果汇总     │
└─────────────┘
```

## 核心类和函数关系

```
┌─────────────────────────────────────────────────────────────────┐
│                        类关系图                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  portfolio_tracking │    │  product_tracking  │                    │
│  │                 │    │                 │                    │
│  │ • __init__()    │    │ • __init__()    │                    │
│  │ • portfolioTracking_main() │    │ • productTracking_main() │                    │
│  └─────────────────┘    └─────────────────┘                    │
│           │                       │                            │
│           │                       │                            │
│           ▼                       ▼                            │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ portfolio_calculation │    │  product_calculation  │                    │
│  │                 │    │                 │                    │
│  │ • __init__()    │    │ • __init__()    │                    │
│  │ • calculate()   │    │ • indexfuture_analysis() │                    │
│  │ • save_result() │    │ • stock_analysis()      │                    │
│  └─────────────────┘    └─────────────────┘                    │
│           │                       │                            │
│           │                       │                            │
│           ▼                       ▼                            │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    数据准备类                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │futureoption_position│  │security_position│  │prod_info    │         │ │
│  │  │             │  │             │  │             │         │ │
│  │  │• df_classification()│  │• df_classification()│  │• get_product_detail()│         │ │
│  │  │• data_reading()    │  │• data_reading()    │  │• assetvalue_processing()│         │ │
│  │  │• pool_withdraw()   │  │• pool_withdraw()   │  │• fill_quantity_with_pre_quantity()│         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                       │                            │
│           └───────────────────────┘                            │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    历史数据管理                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │historySql_saving│  │             │  │             │         │ │
│  │  │             │  │             │  │             │         │ │
│  │  │• __init__() │  │             │  │             │         │ │
│  │  │• historySql_main()│  │             │  │             │         │ │
│  │  │• data_migration()│  │             │  │             │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 函数输入输出关系

### 1. running_main.py 主函数
- **输入**：无
- **输出**：无（执行系统流程）
- **调用关系**：
  - `gt.is_workday_auto()` → 检查工作日
  - `gt.table_manager()` → 数据表管理
  - `portfolio_tracking().portfolioTracking_main()` → 投资组合跟踪
  - `product_tracking().productTracking_main()` → 产品跟踪
  - `historySql_saving().historySql_main()` → 历史数据保存

### 2. data_prepared.py 核心函数

#### a) df_classification(df)
- **输入**：DataFrame (包含code列)
- **输出**：DataFrame (增加asset_type列)
- **功能**：根据code分类资产类型

#### b) get_product_detail(field)
- **输入**：field (name/index/type)
- **输出**：str (产品信息)
- **功能**：从YAML配置读取产品详情

#### c) assetvalue_processing(asset_value, available_date)
- **输入**：asset_value (str/float), available_date (str)
- **输出**：float (处理后的数值)
- **功能**：处理带逗号的字符串数值

#### d) fill_quantity_with_pre_quantity(df)
- **输入**：DataFrame (包含quantity和pre_quantity列)
- **输出**：DataFrame (quantity列填充完成)
- **功能**：用pre_quantity填充空的quantity

### 3. product_calculate.py 核心函数

#### a) indexfuture_analysis()
- **输入**：无
- **输出**：tuple (profit, market_value, DataFrame)
- **功能**：期货期权收益和市值分析

#### b) stock_analysis()
- **输入**：无
- **输出**：tuple (profit, market_value, DataFrame)
- **功能**：股票ETF收益和市值分析

#### c) product_info_processing()
- **输入**：无
- **输出**：DataFrame (产品汇总信息)
- **功能**：汇总所有资产类型的产品信息

### 4. portfolio_calculate.py 核心函数

#### a) portfolio_calculation.__init__(df_initial, df_holding, ...)
- **输入**：多个DataFrame (初始数据、持仓数据等)
- **输出**：无
- **功能**：初始化投资组合计算对象

#### b) calculate()
- **输入**：无
- **输出**：tuple (计算结果)
- **功能**：执行投资组合计算

### 5. history_sql_saving.py 核心函数

#### a) historySql_main()
- **输入**：无
- **输出**：无
- **功能**：执行历史数据保存主流程

#### b) data_migration()
- **输入**：无
- **输出**：无
- **功能**：数据迁移到历史表

## 配置管理

### 1. 全局配置 (global_setting/global_dic.py)
- `source`: 数据源模式 (local/SQL)
- `config_path`: 配置文件路径
- `inputpath_sql`: SQL输入路径

### 2. 产品配置 (project_config/product_detail.yaml)
- 产品代码映射
- 中文名称
- 对应指数
- 产品类型

### 3. SQL配置 (project_config/trackingrealtime_sql.yaml)
- 数据库连接配置
- 表结构定义
- 查询语句配置

## 时间调度逻辑

### 1. 工作日检查
- 使用 `gt.is_workday_auto()` 判断是否为工作日

### 2. 时间条件判断
- **9:00-9:30**: 执行数据表管理
- **9:30-16:00**: 执行投资组合和产品跟踪
- **16:00以后**: 执行历史数据保存

### 3. 自动化触发
- 基于时间的条件执行
- 错误处理和日志记录

## 数据流向

1. **数据输入 → 数据准备 → 计算分析 → 结果输出**
2. **实时数据 → 实时表 → 历史表** (数据持久化)
3. **配置数据 → 全局管理 → 各模块使用**

## 错误处理机制

### 1. 异常捕获
- try-except 块处理运行时错误
- 产品级错误隔离

### 2. 数据验证
- 输入数据格式检查
- 空值处理
- 类型转换验证

### 3. 日志记录
- 错误信息输出
- 执行状态跟踪

## 性能优化

### 1. 数据处理优化
- 批量操作
- 内存管理
- 数据类型优化

### 2. 计算优化
- 向量化操作
- 缓存机制
- 并行处理

### 3. 存储优化
- 索引优化
- 分区策略
- 压缩存储

## 扩展性设计

### 1. 模块化架构
- 功能模块独立
- 接口标准化
- 配置外部化

### 2. 产品扩展
- 新产品类型支持
- 配置驱动
- 插件化设计

### 3. 数据源扩展
- 多数据源支持
- 统一接口
- 动态切换

## 维护指南

### 1. 代码维护
- 详细注释
- 模块化设计
- 版本控制

### 2. 配置维护
- 配置文件管理
- 环境变量设置
- 路径配置

### 3. 数据维护
- 数据备份
- 历史数据清理
- 性能监控

---

**文档版本**：1.0  
**创建日期**：2024年  
**最后更新**：2024年 