Trading System 系统流程图
================================================================================

1. 主系统流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│   系统启动      │
│  running_main   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  目标日期决策    │
│target_date_     │
│decision         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  数据准备       │
│data_prepared    │
│初始化           │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  获取市场数据   │
│mktData_withdraw │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  获取产品信息   │
│productInfo_     │
│withdraw         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  获取目标权重   │
│productTarget    │
│Weight_withdraw  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  获取当前持仓   │
│productHolding_  │
│withdraw         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  持仓构建       │
│holding_         │
│construction     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  交易订单生成   │
│trading_order_   │
│processing       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  数据保存       │
│portfolio_saving │
└─────────┬───────┘
          │
          ▼
        结束

2. 交易订单生成详细流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  获取非交易股票 │
│nontrading_list_ │
│getting          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算锁定资金   │
│非交易股票市值   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  调整可用资金   │
│stock_money -    │
│lock_money       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  资金重平衡     │
│stockmoney_      │
│rebalance        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算目标持仓   │
│weight * money / │
│close            │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算交易差异   │
│target - current │
│holding          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  确定交易方向   │
│买入/卖出/不动   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  生成交易订单   │
│trading_order    │
│文件             │
└─────────┬───────┘
          │
          ▼
        结束

3. 数据保存详细流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  保存组合信息   │
│PortfolioInfo_   │
│saving           │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  保存组合持仓   │
│PortfolioHolinng │
│_saving          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  保存产品权重   │
│ProductWeight_   │
│saving           │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  保存产品持仓   │
│ProductHolding_  │
│saving           │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  SQL数据库保存  │
│sqlSaving_main   │
└─────────┬───────┘
          │
          ▼
        结束

4. 宣夜交易订单生成流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  选择交易模式   │
│TWAP/VWAP        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  读取模板文件   │
│trading_list模板 │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算目标持仓   │
│根据权重和资金   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算交易差异   │
│目标-当前持仓    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  确定交易方向   │
│买入/卖出        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  分离ETF和股票  │
│分别处理         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  生成订单文件   │
│CSV格式输出      │
└─────────┬───────┘
          │
          ▼
        结束

5. 仁睿交易订单生成流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  读取模板文件   │
│默认篮子格式     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算目标持仓   │
│根据权重和资金   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  计算交易差异   │
│目标-当前持仓    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  确定交易方向   │
│0=买入,1=卖出    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  生成订单文件   │
│CSV格式输出      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  保存到数据库   │
│SQL保存          │
└─────────┬───────┘
          │
          ▼
        结束

6. 交易检查流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  目标日期决策   │
│target_date_     │
│decision         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  仁睿持仓检查   │
│renrHolding_     │
│check            │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  读取生产环境   │
│交易订单文件     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  读取测试环境   │
│交易订单文件     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  比较差异       │
│数量/方向差异    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  输出差异报告   │
│打印差异信息     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  宣夜持仓检查   │
│xyHolding_check  │
└─────────┬───────┘
          │
          ▼
        结束

7. 错误处理流程
================================================================================

开始
  │
  ▼
┌─────────────────┐
│  执行主要功能   │
│try块            │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  检查是否异常   │
│except块         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  输出错误信息   │
│print错误消息    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  继续执行       │
│下一个模块       │
└─────────┬───────┘
          │
          ▼
        结束

================================================================================
